#cloud-config

# Set hostname early (before packages install)
hostname: infisical
manage_etc_hosts: true

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg
  - avahi-daemon

write_files:
  - path: /opt/infisical/docker-compose.yml
    permissions: '0644'
    content: |
      version: "3.9"

      services:
        redis:
          image: redis:7-alpine
          container_name: infisical-redis
          restart: unless-stopped
          volumes:
            - redis_data:/data
          healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

        infisical:
          image: infisical/infisical:latest
          container_name: infisical
          restart: unless-stopped
          ports:
            - "8080:8080"
          environment:
            - NODE_ENV=production
            - ENCRYPTION_KEY=${encryption_key}
            - AUTH_SECRET=${auth_secret}
            - DB_CONNECTION_URI=postgres://${postgres_user}:${postgres_password_encoded}@${postgres_host}:${postgres_port}/${postgres_db}
            - REDIS_URL=redis://redis:6379
            - SITE_URL=${site_url != "" ? site_url : "https://infisical.local"}
            - TELEMETRY_ENABLED=false
          depends_on:
            redis:
              condition: service_healthy
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
            interval: 30s
            timeout: 10s
            retries: 5

        nginx:
          image: nginx:alpine
          container_name: infisical-nginx
          restart: unless-stopped
          ports:
            - "443:443"
          volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - ./certs:/etc/nginx/certs:ro
          depends_on:
            - infisical
          healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
            interval: 30s
            timeout: 10s
            retries: 3

      volumes:
        redis_data:

      networks:
        default:
          name: infisical-network

  - path: /opt/infisical/.env
    permissions: '0600'
    content: |
      # Infisical environment - managed by Terraform
      ENCRYPTION_KEY=${encryption_key}
      AUTH_SECRET=${auth_secret}
      POSTGRES_HOST=${postgres_host}
      POSTGRES_PORT=${postgres_port}
      POSTGRES_DB=${postgres_db}
      POSTGRES_USER=${postgres_user}
      POSTGRES_PASSWORD=${postgres_password}

  - path: /opt/infisical/nginx.conf
    permissions: '0644'
    content: |
      events {
          worker_connections 1024;
      }

      http {
          upstream infisical {
              server infisical:8080;
          }

          server {
              listen 80;
              location /health {
                  return 200 'ok';
                  add_header Content-Type text/plain;
              }
              location / {
                  return 301 https://$host$request_uri;
              }
          }

          server {
              listen 443 ssl;
              server_name infisical.local;

              ssl_certificate /etc/nginx/certs/cert.pem;
              ssl_certificate_key /etc/nginx/certs/key.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;

              location / {
                  proxy_pass http://infisical;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  # WebSocket support
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
              }
          }
      }

  - path: /etc/systemd/system/infisical.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Infisical Secret Management
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/infisical
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down

      [Install]
      WantedBy=multi-user.target
%{ if tls_cert != "" ~}

  - path: /opt/infisical/certs/cert.pem
    permissions: '0644'
    content: |
      ${indent(6, tls_cert)}

  - path: /opt/infisical/certs/key.pem
    permissions: '0600'
    content: |
      ${indent(6, tls_key)}
%{ endif ~}

runcmd:
  # Ensure avahi is enabled (hostname already set via cloud-init)
  - systemctl enable avahi-daemon
  - systemctl restart avahi-daemon

  # Install Docker
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Add deployer user to docker group
  - usermod -aG docker deployer

  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Wait for Docker to be ready
  - sleep 10

  # Enable and start Infisical
  - systemctl daemon-reload
  - systemctl enable infisical
  - systemctl start infisical

final_message: "Infisical server is ready! Access at https://$INSTANCE_IP:8443"
