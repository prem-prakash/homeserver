#cloud-config

# Set hostname early (before packages install)
hostname: infisical
manage_etc_hosts: true

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg
  - certbot
  - python3-certbot-dns-cloudflare

write_files:
  - path: /opt/infisical/docker-compose.yml
    permissions: '0644'
    content: |
      version: "3.9"

      services:
        redis:
          image: redis:7-alpine
          container_name: infisical-redis
          restart: unless-stopped
          volumes:
            - redis_data:/data
          healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

        infisical:
          image: infisical/infisical:latest
          container_name: infisical
          restart: unless-stopped
          ports:
            - "8080:8080"
          env_file:
            - .env
          depends_on:
            redis:
              condition: service_healthy
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
            interval: 30s
            timeout: 10s
            retries: 5

        nginx:
          image: nginx:alpine
          container_name: infisical-nginx
          restart: unless-stopped
          ports:
            - "443:443"
            - "80:80"
          volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - /etc/letsencrypt:/etc/letsencrypt:ro
          depends_on:
            - infisical

      volumes:
        redis_data:

      networks:
        default:
          name: infisical-network

  - path: /opt/infisical/.env
    permissions: '0600'
    content: |
      # Infisical environment - managed by Terraform
      NODE_ENV=production
      ENCRYPTION_KEY=${encryption_key}
      AUTH_SECRET=${auth_secret}
      DB_CONNECTION_URI=postgres://${postgres_user}:${postgres_password_encoded}@${postgres_host}:${postgres_port}/${postgres_db}
      REDIS_URL=redis://redis:6379
      SITE_URL=https://${domain}
      TELEMETRY_ENABLED=false

  - path: /opt/infisical/nginx.conf
    permissions: '0644'
    content: |
      events {
          worker_connections 1024;
      }

      http {
          upstream infisical {
              server infisical:8080;
          }

          server {
              listen 80;
              server_name ${domain};

              location / {
                  return 301 https://$host$request_uri;
              }
          }

          server {
              listen 443 ssl;
              server_name ${domain};

              ssl_certificate /etc/letsencrypt/live/${domain}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${domain}/privkey.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;

              location / {
                  proxy_pass http://infisical;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;

                  # WebSocket support
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
              }
          }
      }

  - path: /etc/systemd/system/infisical.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Infisical Secret Management
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/infisical
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down

      [Install]
      WantedBy=multi-user.target

  - path: /etc/letsencrypt/cloudflare.ini
    permissions: '0600'
    content: |
      dns_cloudflare_api_token = ${cloudflare_api_token}

  - path: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      docker exec infisical-nginx nginx -s reload

runcmd:
  # Install Docker
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Add deployer user to docker group
  - usermod -aG docker deployer

  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Create letsencrypt renewal hooks directory
  - mkdir -p /etc/letsencrypt/renewal-hooks/deploy

  # Get Let's Encrypt certificate
  - |
    certbot certonly \
      --dns-cloudflare \
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
      -d ${domain} \
      --non-interactive \
      --agree-tos \
      -m ${letsencrypt_email}

  # Wait for Docker to be ready
  - sleep 10

  # Enable and start Infisical
  - systemctl daemon-reload
  - systemctl enable infisical
  - systemctl start infisical

final_message: "Infisical server is ready at https://${domain}"
